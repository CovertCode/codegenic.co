<!DOCTYPE html>
<html lang="en-US"><head><meta charset="UTF-8"><title>Protecting SSL Private Keys in NGINX with HashiCorp Vault – Developer</title><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//s.w.org"><link rel="stylesheet" id="wp-block-library-css" href="https://codegenic.co/in/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all"><link rel="stylesheet" id="mrseo_elated_default_style-css" href="https://codegenic.co/in/wp-content/themes/mrseo/style.css" type="text/css" media="all"><link rel="stylesheet" id="mrseo_elated_modules-css" href="https://codegenic.co/in/wp-content/themes/mrseo/assets/css/modules.min.css" type="text/css" media="all"><style id="mrseo_elated_modules-inline-css" type="text/css">
/* generated in /var/www/codescreen.local/htdocs/wp-content/themes/mrseo/framework/admin/options/general/map.php mrseo_elated_page_general_style function */
.postid-4216.eltdf-boxed .eltdf-wrapper { background-attachment: fixed;}


</style><link rel="stylesheet" id="eltdf_font_awesome-css" href="https://codegenic.co/in/wp-content/themes/mrseo/assets/css/font-awesome/css/font-awesome.min.css" type="text/css" media="all"><link rel="stylesheet" id="eltdf_font_elegant-css" href="https://codegenic.co/in/wp-content/themes/mrseo/assets/css/elegant-icons/style.min.css" type="text/css" media="all"><link rel="stylesheet" id="eltdf_ion_icons-css" href="https://codegenic.co/in/wp-content/themes/mrseo/assets/css/ion-icons/css/ionicons.min.css" type="text/css" media="all"><link rel="stylesheet" id="eltdf_linea_icons-css" href="https://codegenic.co/in/wp-content/themes/mrseo/assets/css/linea-icons/style.css" type="text/css" media="all"><link rel="stylesheet" id="mediaelement-css" href="https://codegenic.co/in/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css" type="text/css" media="all"><link rel="stylesheet" id="wp-mediaelement-css" href="https://codegenic.co/in/wp-includes/js/mediaelement/wp-mediaelement.min.css" type="text/css" media="all"><link rel="stylesheet" id="mrseo_elated_modules_responsive-css" href="https://codegenic.co/in/wp-content/themes/mrseo/assets/css/modules-responsive.min.css" type="text/css" media="all"><link rel="stylesheet" id="mrseo_elated_google_fonts-css" href="http://fonts.googleapis.com/css?family=Catamaran%3A100%2C100i%2C200%2C200i%2C300%2C300i%2C400%2C400i%2C500%2C500i%2C600%2C600i%2C700%2C700i%2C800%2C800i%2C900%2C900i%7CRaleway%3A100%2C100i%2C200%2C200i%2C300%2C300i%2C400%2C400i%2C500%2C500i%2C600%2C600i%2C700%2C700i%2C800%2C800i%2C900%2C900i&subset=latin-ext&ver=1.0.0" type="text/css" media="all"><link rel="stylesheet" id="jet-elements-css" href="https://codegenic.co/in/wp-content/plugins/jet-elements/assets/css/jet-elements.css" type="text/css" media="all"><link rel="stylesheet" id="jet-elements-skin-css" href="https://codegenic.co/in/wp-content/plugins/jet-elements/assets/css/jet-elements-skin.css" type="text/css" media="all"><link rel="stylesheet" id="elementor-icons-css" href="https://codegenic.co/in/wp-content/plugins/elementor/assets/lib/eicons/css/elementor-icons.min.css" type="text/css" media="all"><link rel="stylesheet" id="font-awesome-css" href="https://codegenic.co/in/wp-content/plugins/elementor/assets/lib/font-awesome/css/font-awesome.min.css" type="text/css" media="all"><link rel="stylesheet" id="elementor-animations-css" href="https://codegenic.co/in/wp-content/plugins/elementor/assets/lib/animations/animations.min.css" type="text/css" media="all"><link rel="stylesheet" id="elementor-frontend-css" href="https://codegenic.co/in/wp-content/plugins/elementor/assets/css/frontend.min.css" type="text/css" media="all"><link rel="stylesheet" id="powerpack-frontend-css" href="https://codegenic.co/in/wp-content/plugins/powerpack-elements/assets/css/frontend.css" type="text/css" media="all"><link rel="stylesheet" id="elementor-pro-css" href="https://codegenic.co/in/wp-content/plugins/elementor-pro/assets/css/frontend.min.css" type="text/css" media="all"><link rel="stylesheet" id="elementor-global-css" href="https://codegenic.co/in/wp-content/uploads/sites/2/elementor/css/global.css" type="text/css" media="all"><link rel="stylesheet" id="elementor-post-4216-css" href="https://codegenic.co/in/wp-content/uploads/sites/2/elementor/css/post-4216.css" type="text/css" media="all"><link rel="stylesheet" id="google-fonts-1-css" href="https://fonts.googleapis.com/css?family=Roboto%3A100%2C100italic%2C200%2C200italic%2C300%2C300italic%2C400%2C400italic%2C500%2C500italic%2C600%2C600italic%2C700%2C700italic%2C800%2C800italic%2C900%2C900italic%7CRoboto+Slab%3A100%2C100italic%2C200%2C200italic%2C300%2C300italic%2C400%2C400italic%2C500%2C500italic%2C600%2C600italic%2C700%2C700italic%2C800%2C800italic%2C900%2C900italic&ver=5.1.1" type="text/css" media="all"><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/jquery.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/jquery-migrate.min.js"></script><script type="text/javascript">
var mejsL10n = {"language":"en","strings":{"mejs.install-flash":"You are using a browser that does not have Flash player enabled or installed. Please turn on your Flash player plugin or download the latest version from https:\/\/get.adobe.com\/flashplayer\/","mejs.fullscreen-off":"Turn off Fullscreen","mejs.fullscreen-on":"Go Fullscreen","mejs.download-video":"Download Video","mejs.fullscreen":"Fullscreen","mejs.time-jump-forward":["Jump forward 1 second","Jump forward %1 seconds"],"mejs.loop":"Toggle Loop","mejs.play":"Play","mejs.pause":"Pause","mejs.close":"Close","mejs.time-slider":"Time Slider","mejs.time-help-text":"Use Left\/Right Arrow keys to advance one second, Up\/Down arrows to advance ten seconds.","mejs.time-skip-back":["Skip back 1 second","Skip back %1 seconds"],"mejs.captions-subtitles":"Captions\/Subtitles","mejs.captions-chapters":"Chapters","mejs.none":"None","mejs.mute-toggle":"Mute Toggle","mejs.volume-help-text":"Use Up\/Down Arrow keys to increase or decrease volume.","mejs.unmute":"Unmute","mejs.mute":"Mute","mejs.volume-slider":"Volume Slider","mejs.video-player":"Video Player","mejs.audio-player":"Audio Player","mejs.ad-skip":"Skip ad","mejs.ad-skip-info":["Skip in 1 second","Skip in %1 seconds"],"mejs.source-chooser":"Source Chooser","mejs.stop":"Stop","mejs.speed-rate":"Speed Rate","mejs.live-broadcast":"Live Broadcast","mejs.afrikaans":"Afrikaans","mejs.albanian":"Albanian","mejs.arabic":"Arabic","mejs.belarusian":"Belarusian","mejs.bulgarian":"Bulgarian","mejs.catalan":"Catalan","mejs.chinese":"Chinese","mejs.chinese-simplified":"Chinese (Simplified)","mejs.chinese-traditional":"Chinese (Traditional)","mejs.croatian":"Croatian","mejs.czech":"Czech","mejs.danish":"Danish","mejs.dutch":"Dutch","mejs.english":"English","mejs.estonian":"Estonian","mejs.filipino":"Filipino","mejs.finnish":"Finnish","mejs.french":"French","mejs.galician":"Galician","mejs.german":"German","mejs.greek":"Greek","mejs.haitian-creole":"Haitian Creole","mejs.hebrew":"Hebrew","mejs.hindi":"Hindi","mejs.hungarian":"Hungarian","mejs.icelandic":"Icelandic","mejs.indonesian":"Indonesian","mejs.irish":"Irish","mejs.italian":"Italian","mejs.japanese":"Japanese","mejs.korean":"Korean","mejs.latvian":"Latvian","mejs.lithuanian":"Lithuanian","mejs.macedonian":"Macedonian","mejs.malay":"Malay","mejs.maltese":"Maltese","mejs.norwegian":"Norwegian","mejs.persian":"Persian","mejs.polish":"Polish","mejs.portuguese":"Portuguese","mejs.romanian":"Romanian","mejs.russian":"Russian","mejs.serbian":"Serbian","mejs.slovak":"Slovak","mejs.slovenian":"Slovenian","mejs.spanish":"Spanish","mejs.swahili":"Swahili","mejs.swedish":"Swedish","mejs.tagalog":"Tagalog","mejs.thai":"Thai","mejs.turkish":"Turkish","mejs.ukrainian":"Ukrainian","mejs.vietnamese":"Vietnamese","mejs.welsh":"Welsh","mejs.yiddish":"Yiddish"}};
</script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/mediaelement/mediaelement-and-player.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/mediaelement/mediaelement-migrate.min.js"></script><script type="text/javascript">
/* <![CDATA[ */
var _wpmejsSettings = {"pluginPath":"\/developer\/wp-includes\/js\/mediaelement\/","classPrefix":"mejs-","stretching":"responsive"};
/* ]]> */
</script><style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"></head><body class="post-template post-template-elementor_canvas single single-post postid-4216 single-format-standard mrseo-ver-1.6 eltdf-sticky-header-on-scroll-down-up eltdf-dropdown-animate-height eltdf-header-standard eltdf-menu-area-shadow-disable eltdf-menu-area-in-grid-shadow-disable eltdf-menu-area-border-disable eltdf-menu-area-in-grid-border-disable eltdf-logo-area-border-disable eltdf-logo-area-in-grid-border-disable eltdf-header-vertical-shadow-disable eltdf-header-vertical-border-disable eltdf-default-mobile-header eltdf-sticky-up-mobile-header elementor-default elementor-template-canvas elementor-page elementor-page-4216">
			<div data-elementor-type="post" data-elementor-id="4216" class="elementor elementor-4216" data-elementor-settings="[]">
			<div class="elementor-inner">
				<div class="elementor-section-wrap">
							<section class="elementor-element elementor-element-3ff70d7f elementor-section-boxed elementor-section-height-default elementor-section-height-default elementor-section elementor-top-section" data-id="3ff70d7f" data-element_type="section" data-settings='{"background_background":"gradient","shape_divider_bottom":"clouds","shape_divider_bottom_negative":"yes"}'><div class="elementor-background-overlay"></div>
						<div class="elementor-shape elementor-shape-bottom" data-negative="true">
			<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 283.5 27.8" preserveaspectratio="xMidYMax slice"><path class="elementor-shape-fill" d="M265.8 3.5c-10.9 0-15.9 6.2-15.9 6.2s-3.6-3.5-9.2-.9c-9.1 4.1-4.4 13.4-4.4 13.4s-1.2.2-1.9.9c-.6.7-.5 1.9-.5 1.9s-1-.5-2.3-.2c-1.3.3-1.6 1.4-1.6 1.4s.4-3.4-1.5-5c-3.9-3.4-8.3-.2-8.3-.2s-.6-.7-.9-.9c-.4-.2-1.2-.2-1.2-.2s-4.4-3.6-11.5-2.6-10.4 7.9-10.4 7.9-.5-3.3-3.9-4.9c-4.8-2.4-7.4 0-7.4 0s2.4-4.1-1.9-6.4-6.2 1.2-6.2 1.2-.9-.5-2.1-.5-2.3 1.1-2.3 1.1.1-.7-1.1-1.1c-1.2-.4-2 0-2 0s3.6-6.8-3.5-8.9c-6-1.8-7.9 2.6-8.4 4-.1-.3-.4-.7-.9-1.1-1-.7-1.3-.5-1.3-.5s1-4-1.7-5.2c-2.7-1.2-4.2 1.1-4.2 1.1s-3.1-1-5.7 1.4-2.1 5.5-2.1 5.5-.9 0-2.1.7-1.4 1.7-1.4 1.7-1.7-1.2-4.3-1.2c-2.6 0-4.5 1.2-4.5 1.2s-.7-1.5-2.8-2.4c-2.1-.9-4 0-4 0s2.6-5.9-4.7-9c-7.3-3.1-12.6 3.3-12.6 3.3s-.9 0-1.9.2c-.9.2-1.5.9-1.5.9S99.4 3 94.9 3.9c-4.5.9-5.7 5.7-5.7 5.7s-2.8-5-12.3-3.9-11.1 6-11.1 6-1.2-1.4-4-.7c-.8.2-1.3.5-1.8.9-.9-2.1-2.7-4.9-6.2-4.4-3.2.4-4 2.2-4 2.2s-.5-.7-1.2-.7h-1.4s-.5-.9-1.7-1.4-2.4 0-2.4 0-2.4-1.2-4.7 0-3.1 4.1-3.1 4.1-1.7-1.4-3.6-.7c-1.9.7-1.9 2.8-1.9 2.8s-.5-.5-1.7-.2c-1.2.2-1.4.7-1.4.7s-.7-2.3-2.8-2.8c-2.1-.5-4.3.2-4.3.2s-1.7-5-11.1-6c-3.8-.4-6.6.2-8.5 1v21.2h283.5V11.1c-.9.2-1.6.4-1.6.4s-5.2-8-16.1-8z"></path></svg></div>
					<div class="elementor-container elementor-column-gap-default">
				<div class="elementor-row">
				<div class="elementor-element elementor-element-268951e1 elementor-column elementor-col-100 elementor-top-column" data-id="268951e1" data-element_type="column">
			<div class="elementor-column-wrap  elementor-element-populated">
					<div class="elementor-widget-wrap">
				<div class="elementor-element elementor-element-1ad71b87 elementor-widget elementor-widget-heading" data-id="1ad71b87" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
			<h2 class="elementor-heading-title elementor-size-default"><h1>Protecting SSL Private Keys in NGINX with HashiCorp Vault</h1></h2>		</div>
				</div>
						</div>
			</div>
		</div>
						</div>
			</div>
		</section><section class="elementor-element elementor-element-51a78908 elementor-section-boxed elementor-section-height-default elementor-section-height-default elementor-section elementor-top-section" data-id="51a78908" data-element_type="section"><div class="elementor-container elementor-column-gap-default">
				<div class="elementor-row">
				<div class="elementor-element elementor-element-23f66114 elementor-column elementor-col-100 elementor-top-column" data-id="23f66114" data-element_type="column">
			<div class="elementor-column-wrap  elementor-element-populated">
					<div class="elementor-widget-wrap">
				<div class="elementor-element elementor-element-284d48c3 elementor-widget elementor-widget-image" data-id="284d48c3" data-element_type="widget" data-widget_type="image.default">
				<div class="elementor-widget-container">
					<div class="elementor-image">
										<img width="234" height="234" src="https://codegenic.co/in/wp-content/uploads/sites/2/2019/04/groomsman3.jpg" class="attachment-full size-full" alt="" srcset="https://codegenic.co/in/wp-content/uploads/sites/2/2019/04/groomsman3.jpg 234w,https://codegenic.co/in/wp-content/uploads/sites/2/2019/04/groomsman3-150x150.jpg 150w" sizes="(max-width: 234px) 100vw, 234px"></div>
				</div>
				</div>
				<div class="elementor-element elementor-element-3621f35 elementor-widget elementor-widget-heading" data-id="3621f35" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
			<h4 class="elementor-heading-title elementor-size-default">By NICK JOHNSON</h4>		</div>
				</div>
				<div class="elementor-element elementor-element-2e93ed0c elementor-widget elementor-widget-spacer" data-id="2e93ed0c" data-element_type="widget" data-widget_type="spacer.default">
				<div class="elementor-widget-container">
					<div class="elementor-spacer">
			<div class="elementor-spacer-inner"></div>
		</div>
				</div>
				</div>
				<div class="elementor-element elementor-element-5cc899ca elementor-widget elementor-widget-text-editor" data-id="5cc899ca" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
					<div class="elementor-text-editor elementor-clearfix"><div><p>In the <a href="https://www.nginx.com/blog/secure-distribution-ssl-private-keys-nginx/">first post in this series</a>, we describe several approaches to improving the security of your SSL private keys. The post finished with a demonstration of a remote password distribution point (PDP) used to securely share encryption passwords with NGINX instances.</p><p>Secrets management systems like <a href="https://www.vaultproject.io/intro/use-cases.html#general-secret-storage" target="_blank" rel="noopener">HashiCorp Vault</a> operate in a similar fashion to that sample PDP:</p><ul><li>They use a central (or highly available and distributed) secrets service that is accessed using HTTPS or another API</li><li>Clients are authenticated by authentication tokens or other means</li><li>Tokens can be revoked as required to control access to the secret</li></ul><p>In this post, we show how to set up HashiCorp Vault to distribute SSL passwords. For even more security, you can <a href="https://www.nginx.com/blog/protecting-ssl-private-keys-nginx-hashicorp-vault/#hsm">set up an external hardware security module</a> (HSM).</p><p>This post applies to both NGINX Open Source and NGINX Plus. For ease of reading, we’ll refer to <em>NGINX</em> throughout.</p><h2>Using HashiCorp Vault to Protect SSL Private Keys</h2><p>The instructions in this section set up a central PDP server using Vault to distribute SSL passwords. They are based on <a href="https://www.digitalocean.com/community/tutorials/how-to-securely-manage-secrets-with-hashicorp-vault-on-ubuntu-16-04" target="_blank" rel="noopener">DigitalOcean’s instructions</a>; modify them as necessary to comply with your own Vault policies.</p><p>In our example, each remote web server has a unique authentication token. These tokens can be used to access secrets in Vault’s <strong>secret/webservers/</strong> path, and we store the SSL passwords in <strong>secret/webservers/ssl_passwords</strong>.</p><p>We will see how to secure the tokens, and how to revoke individual authentication tokens when necessary.</p><h3>Download, Install, and Initialize HashiCorp Vault on the PDP Server</h3><ol><li><p>Follow the <a href="https://www.digitalocean.com/community/tutorials/how-to-securely-manage-secrets-with-hashicorp-vault-on-ubuntu-16-04" target="_blank" rel="noopener">DigitalOcean instructions</a> to download and extract Vault on your PDP server. We’re using the following sample <strong>/etc/vault.hcl</strong> file to make Vault remotely accessible, and to disable TLS (for ease of use when testing):</p><pre><code>backend "file" {
    path = "/var/lib/vault"
}

listener "tcp" {
    address = "0.0.0.0:8200"
    tls_disable = 1
}</code></pre></li><li><p>Start Vault using the startup scripts (if you created them), or manually:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">sudo /usr/local/bin/vault server -config=/etc/vault.hcl</span></code></pre></li><li><p>Initialize Vault and obtain the Initial Root Token:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">export VAULT_ADDR=http://localhost:8200</span>
user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">vault init -key-shares=3 -key-threshold=2</span>
user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">vault operator unseal</span>
Initial Root Token: 86c5c2a4-8ab2-24dd-1816-48449c83114e</code></pre></li><li><p>We need to provide the Initial Root Token in many of the following commands. For convenience, we assign it to the <code>root_token</code> shell variable:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">root_token=86c5c2a4-8ab2-24dd-1816-48449c83114e</span></code></pre></li></ol><h3>Store the Secrets</h3><ol start="5"><li>Still working on the PDP server, create a temporary file called <strong>/tmp/ssl_passwords.txt</strong> with the passwords in it.</li><li><p>Store this file as a secret in Vault, and verify that you can retrieve it:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault kv put secret/webservers/ssl_passwords value=@/tmp/ssl_passwords.txt</span>

user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault kv get -field=value secret/webservers/ssl_passwords</span>
password1
password2
...</code></pre></li><li>For security, delete <strong>/tmp/ssl_passwords.txt</strong>.</li><li><p>Create a policy specification in a file called <strong>web.hcl</strong> with the following contents:</p><pre><code>path "secret/webservers/*" {
    capabilities = ["read"]
}</code></pre></li><li><p>Load the policy into Vault, naming it <code>web</code>:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault policy write web web.hcl</span></code></pre></li><li><p>Create a new authentication token, associate it with the <code>web</code> policy, and optionally include the <span style="white-space: nowrap;"><code>display-name</code></span> parameter to give it a user‑friendly name. Make a note of the <code>token</code> and <code>token_accessor</code> values; you’ll use them in subsequent commands:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault token create -policy=web -display-name=webserver1</span>
Key                  Value
---                  -----
token                dcf75ffd-a245-860f-6960-dc9e834d3385
token_accessor       0c1d6181-7adf-7b42-27be-b70cfa264048</code></pre><p>The NGINX web server uses this token to retrieve the SSL passwords. The <code>web</code> policy prevents the web server from retrieving secrets outside the <strong>secret/webservers/*</strong> path.</p></li></ol><h3>Verify the Web Server Can Retrieve the Token</h3><ol><li>Working on the NGINX web server, install the Vault binary.</li><li><p>Declare the location of the remote Vault server (here, <strong>http://pdp:8200</strong>), and then verify that the web server machine can retrieve the SSL passwords using the token:</p><pre><code>user@web1:~$ <span style="color: #66ff99; font-weight: bold;">export VAULT_ADDR=http://pdp:8200</span>
user@web1:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=dcf75ffd-a245-860f-6960-dc9e834d3385 vault kv get -field=value secret/webservers/ssl_passwords</span>
password1
password2
...</code></pre></li></ol><h3>Configure the NGINX Vault Connector on the Web Server</h3><ol start="3"><li><p>As part of setting up the sample PDP in the <a href="https://www.nginx.com/blog/secure-distribution-ssl-private-keys-nginx/#pdp">first post</a>, we created a shell script called <strong>connector.sh</strong> on the NGINX host (web server machine). Here we modify it to use Vault:</p><pre><code>#!/bin/sh
# Usage: connector_v.sh  

CONNECTOR=$1
CREDS=$2

[ -e $CONNECTOR ] && /bin/rm -f $CONNECTOR

mkfifo $CONNECTOR; chmod 600 $CONNECTOR

export VAULT_ADDR=http://pdp:8200
export VAULT_TOKEN=$CREDS

while true; do
    vault kv get -field=value secret/webservers/ssl_passwords > $CONNECTOR
    sleep 0.1 # race condition, ensures EOF
done</code></pre></li><li><p>Run the script as a background process, invoked as follows:</p><pre><code>root@web1:~# <span style="color: #66ff99; font-weight: bold;">./connector_v.sh /var/run/nginx/ssl_passwords \
dcf75ffd-a245-860f-6960-dc9e834d3385 &</span></code></pre></li><li><p>Test the connector by reading from the connector path:</p><pre><code>root@web1:~$ <span style="color: #66ff99; font-weight: bold;">cat /var/run/nginx/ssl_passwords</span>
password1
password2
...</code></pre></li><li><p>Configure NGINX to read the <strong>ssl_passwords</strong> file on startup, and to use the contents as passwords to decrypt encrypted private keys. You can include the <a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_password_file" target="_blank" rel="noopener"><code>ssl_password_file</code></a> directive either in a <code>server</code> block (like the one created for the <a href="https://www.nginx.com/blog/secure-distribution-ssl-private-keys-nginx/#standard-config">standard configuration</a> in the first post) or in the <code>http</code> context to apply it to multiple virtual servers:</p><pre><code>ssl_password_file /var/run/nginx/ssl_passwords;</code></pre></li><li><p>Verify that NGINX can read the password and decrypt the SSL keys:</p><pre><code>root@web1:~# <span style="color: #66ff99; font-weight: bold;">nginx -t</span>
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful</code></pre></li></ol><h3>Revoking a Web Server’s Authentication Token</h3><p>You can easily revoke access if the web server is compromised or when it is decommissioned. To do so, you can directly revoke the authentication token used by the web server:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault token revoke dcf75ffd-a245-860f-6960-dc9e834d3385</span></code></pre><p>Vault tokens are sensitive items of data, and many Vault workflows do not store copies of tokens that are issued to an authenticated client. If a copy of a token is leaked, an attacker can impersonate the client.</p><p>Instead, it’s common to manage an active token using its <a href="https://www.vaultproject.io/docs/concepts/tokens.html#token-accessors" target="_blank" rel="noopener">accessor</a>, which gives limited rights over the token and cannot be used to retrieve the token value. Rather than storing tokens when they are issued, store its corresponding accessor.</p><p>If you need to determine the accessor for a web server’s authentication token, run the <span style="white-space: nowrap;"><code>vault</code> <code>list</code></span> command to retrieve the list of accessors, and the <span style="white-space: nowrap;"><code>vault</code> <code>token</code> <code>lookup</code></span> command on each accessor to find the one with the relevant display name and policy:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault list /auth/token/accessors</span>
Keys
----
83be5a73-9025-1221-cb70-4b0e8a3ba8df
0c1d6181-7adf-7b42-27be-b70cfa264048
f043b145-7a63-01db-ea85-9f22f413c55e
user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault token lookup -accessor 0c1d6181-7adf-7b42-27be-b70cfa264048</span>
Key                 Value
---                 -----
...
display-name        webserver1       
...
policy              web
...</code></pre><p>You can then revoke the token using its accessor:</p><pre><code>user@pdp:~$ <span style="color: #66ff99; font-weight: bold;">VAULT_TOKEN=$root_token vault token revoke -accessor 0c1d6181-7adf-7b42-27be-b70cfa264048</span></code></pre><h3>Security Implications</h3><p>Using Vault has a similar security profile to the sample PDP described in the <a href="https://www.nginx.com/blog/secure-distribution-ssl-private-keys-nginx/#pdp">first post</a>. SSL private keys can only be obtained if the corresponding password is obtained, and for this, an attacker needs to know the value of a current authentication token.</p><p>The primary benefit of using Vault is to automate and scale the secret store.</p><h2>Using an External HSM to Manage Private Keys</h2><p>None of the solutions we’ve covered so far in the series protect the private key when an attacker gains <code>root</code> access to the NGINX server.If an attacker can access NGINX’s runtime memory or generate a core dump, there are well‑known techniques to scan the process’s memory and locate private key data.</p><p>External hardware security modules (HSMs) address this by storing the SSL private keys in external, tamper‑proof hardware. They offer decryption as a service, and NGINX accesses that service whenever it needs to perform an SSL operation that requires the kay.</p><p>The NGINX server never sees the SSL private key data. An attacker who gains <code>root</code> access on the server cannot obtain the SSL private key, but can decrypt data on demand by accessing the HSM decryption service using the NGINX credentials.</p><h3>Configuring NGINX to Access an HSM</h3><p>NGINX delegates all SSL private key operations to a crypto library called OpenSSL. Third‑party HSM devices can be made available to NGINX by using the HSM vendor’s OpenSSL engine.</p><p>The NGINX configuration is specific to each vendor HSM, but generally follows a straightforward path:</p><ul><li><p>Configure NGINX to use the vendor’s OpenSSL engine rather than the default software engine:</p><pre><code><a href="https://nginx.org/en/docs/ngx_core_module.html#ssl_engine" target="_blank" rel="noopener">ssl_engine</a> vendor-hsm-engine;</code></pre></li><li><p>Rather than using the real private key, configure NGINX to use the vendor‑supplied ‘fake’ key. This key contains a handle that identifies the real key on the HSM device:</p><pre><code><a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate_key" target="_blank" rel="noopener">ssl_certificate_key</a> ssl/vendor.private.key;</code></pre><p>The key may also contain the credentials to access the HSM device, or the credentials may be provided using additional vendor‑specific configuration.</p></li><li><p>(Optional) Apply any desired tuning, such as increasing the number of NGINX worker processes, to maximize the performance of NGINX and the HSM.</p></li></ul><p>For an example of HSM setup, refer to <a href="https://docs.aws.amazon.com/cloudhsm/latest/userguide/ssl-offload-configure-web-server.html#update-web-server-config-nginx" target="_blank" rel="noopener">Amazon’s CloudHSM documentation</a>.</p><h3>Security Implications</h3><p>External HSMs are a highly secure method of storing SSL private keys. An attacker with <code>root</code> access to the NGINX server is able to leverage the NGINX credentials to decrypt arbitrary data using the HSM but is not able to obtain the unencrypted private key. An HSM makes it significantly harder for an attacker to impersonate a website or to decrypt arbitrary data offline.</p><h2>Conclusion</h2><p>It’s essential to ensure that secret data such as the SSL private key is fully protected because the consequences of disclosure are very serious.</p><p>For many organizations with appropriate security processes in place, it’s sufficient to store the private key on the frontend load balancers and then limit and audit all access to those servers (the <a href="https://www.nginx.com/blog/secure-distribution-ssl-private-keys-nginx/#standard-config">standard configuration</a> described on the first post).</p><p>For organizations that need to deploy NGINX configuration frequently, the measures in this post and the first one can be used to limit the users or entities who can see the private key data.</p><p>In the final post in this series, we’ll explain how to automate the provisioning of keys and certificates from Vault to NGINX Plus’s <a href="https://nginx.org/en/docs/http/ngx_http_keyval_module.html" target="_blank" rel="noopener">key‑value store</a>, using the <span style="white-space: nowrap;">NGINX Plus API</span>.</p><p>Note again that none of these methods reduces the need to fully secure the running NGINX instances from remote access or configuration manipulation.</p></div><div style="background-image: url('https://www.nginx.com/wp-content/uploads/2016/05/ebk-Microservices-Deployment-blog-footer-1024x568.png;"><br><div><div>Microservices: From Design to Deployment</div><p>The complete guide to microservices development</p><div><a href="https://www.nginx.com/resources/library/designing-deploying-microservices/">Download now</a></div></div></div></div>
				</div>
				</div>
				<div class="elementor-element elementor-element-2244723a elementor-widget elementor-widget-text-editor" data-id="2244723a" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
					<div class="elementor-text-editor elementor-clearfix"><p>“Class aptent taciti sociosqu ad litora per conubia nostra, per inceptos himenaeos .Aenean non turpis vitae ligula tristique sagitt isras varius erat pulvinar eros pretium”</p></div>
				</div>
				</div>
				<div class="elementor-element elementor-element-6e270cf2 elementor-widget elementor-widget-text-editor" data-id="6e270cf2" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
					<div class="elementor-text-editor elementor-clearfix"><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus quis arcu est. Quisque posuere est arcu, id hendrerit orci pulvinar id. Cras egestas metus sit amet felis accumsan, vitae placerat libero sodales. Morbi efficitur maximus massa et aliquam. Quisque vel viverra augue.</p><p>Nullam scelerisque erat nisl, eu aliquet quam porttitor et. Aliquam molestie sem augue, non egestas nunc sagittis in. Suspendisse vehicula turpis eget leo sollicitudin, dapibus commodo massa facilisis.</p><p>Ut ac tortor eget nibh condimentum congue. In facilisis porttitor iaculis. Etiam vestibulum, nisl nec molestie egestas, velit lorem venenatis tellus, pellentesque blandit nulla sapien accumsan velit. Vivamus purus nunc, dictum nec elit viverra, semper iaculis risus.</p></div>
				</div>
				</div>
						</div>
			</div>
		</div>
						</div>
			</div>
		</section><section class="elementor-element elementor-element-7677cb74 elementor-section-boxed elementor-section-height-default elementor-section-height-default elementor-section elementor-top-section" data-id="7677cb74" data-element_type="section"><div class="elementor-container elementor-column-gap-no">
				<div class="elementor-row">
				<div class="elementor-element elementor-element-273a0e81 elementor-column elementor-col-100 elementor-top-column" data-id="273a0e81" data-element_type="column">
			<div class="elementor-column-wrap">
					<div class="elementor-widget-wrap">
						</div>
			</div>
		</div>
						</div>
			</div>
		</section><section class="elementor-element elementor-element-34b63513 elementor-section-boxed elementor-section-height-default elementor-section-height-default elementor-section elementor-top-section" data-id="34b63513" data-element_type="section"><div class="elementor-container elementor-column-gap-default">
				<div class="elementor-row">
				<div class="elementor-element elementor-element-68d473aa elementor-column elementor-col-100 elementor-top-column" data-id="68d473aa" data-element_type="column">
			<div class="elementor-column-wrap  elementor-element-populated">
					<div class="elementor-widget-wrap">
				<div class="elementor-element elementor-element-7bf4b301 elementor-widget elementor-widget-text-editor" data-id="7bf4b301" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
					<div class="elementor-text-editor elementor-clearfix"><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus quis arcu est. Quisque posuere est arcu, id hendrerit orci pulvinar id. Cras egestas metus sit amet felis accumsan, vitae placerat libero sodales. Morbi efficitur maximus massa et aliquam. Quisque vel viverra augue.</p><p>Nullam scelerisque erat nisl, eu aliquet quam porttitor et. Aliquam molestie sem augue, non egestas nunc sagittis in. Suspendisse vehicula turpis eget leo sollicitudin, dapibus commodo massa facilisis.</p><p>“Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos.Aenean non turpis vitae ligula tristique sagittis. Cras varius erat pulvinar eros pretium suscipit. Duis eleifend sit amet sapien sed ultricies.”</p><p>Ut ac tortor eget nibh condimentum congue. In facilisis porttitor iaculis. Etiam vestibulum, nisl nec molestie egestas, velit lorem venenatis tellus, pellentesque blandit nulla sapien accumsan velit. Vivamus purus nunc, dictum nec elit viverra, semper iaculis risus.</p></div>
				</div>
				</div>
						</div>
			</div>
		</div>
						</div>
			</div>
		</section><section class="elementor-element elementor-element-11edecb0 elementor-section-boxed elementor-section-height-default elementor-section-height-default elementor-section elementor-top-section" data-id="11edecb0" data-element_type="section"><div class="elementor-container elementor-column-gap-default">
				<div class="elementor-row">
				<div class="elementor-element elementor-element-765e957d elementor-column elementor-col-100 elementor-top-column" data-id="765e957d" data-element_type="column">
			<div class="elementor-column-wrap  elementor-element-populated">
					<div class="elementor-widget-wrap">
				<div class="elementor-element elementor-element-425030cd elementor-widget elementor-widget-divider" data-id="425030cd" data-element_type="widget" data-widget_type="divider.default">
				<div class="elementor-widget-container">
					<div class="elementor-divider">
			<span class="elementor-divider-separator"></span>
		</div>
				</div>
				</div>
				<div class="elementor-element elementor-element-4482b0df elementor-widget elementor-widget-heading" data-id="4482b0df" data-element_type="widget" data-widget_type="heading.default">
				<div class="elementor-widget-container">
			<h4 class="elementor-heading-title elementor-size-default">Spread the word</h4>		</div>
				</div>
				<div class="elementor-element elementor-element-9407208 elementor-shape-circle elementor-widget elementor-widget-social-icons" data-id="9407208" data-element_type="widget" data-widget_type="social-icons.default">
				<div class="elementor-widget-container">
					<div class="elementor-social-icons-wrapper">
							<a class="elementor-icon elementor-social-icon elementor-social-icon-facebook" href="" target="_blank">
					<span class="elementor-screen-only">Facebook</span>
					<i class="fa fa-facebook"></i>
				</a>
							<a class="elementor-icon elementor-social-icon elementor-social-icon-twitter" href="" target="_blank">
					<span class="elementor-screen-only">Twitter</span>
					<i class="fa fa-twitter"></i>
				</a>
							<a class="elementor-icon elementor-social-icon elementor-social-icon-google-plus" href="" target="_blank">
					<span class="elementor-screen-only">Google-plus</span>
					<i class="fa fa-google-plus"></i>
				</a>
							<a class="elementor-icon elementor-social-icon elementor-social-icon-linkedin" href="" target="_blank">
					<span class="elementor-screen-only">Linkedin</span>
					<i class="fa fa-linkedin"></i>
				</a>
							<a class="elementor-icon elementor-social-icon elementor-social-icon-snapchat" href="" target="_blank">
					<span class="elementor-screen-only">Snapchat</span>
					<i class="fa fa-snapchat"></i>
				</a>
					</div>
				</div>
				</div>
						</div>
			</div>
		</div>
						</div>
			</div>
		</section></div>
			</div>
		</div>
		<script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/ui/core.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/ui/widget.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/ui/tabs.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/ui/accordion.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/mediaelement/wp-mediaelement.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.appear.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/modernizr.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/hoverIntent.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.plugin.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.countdown.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/owl.carousel.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/parallax.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/easypiechart.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/powerpack-elements/assets/lib/waypoints/waypoints.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/Chart.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/counter.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/absoluteCounter.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/fluidvids.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.prettyPhoto.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.nicescroll.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/ScrollToPlugin.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.waitforimages.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.easing.1.3.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/jquery.multiscroll.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/powerpack-elements/assets/lib/isotope/isotope.pkgd.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules/plugins/packery-mode.pkgd.min.js"></script><script type="text/javascript">
/* <![CDATA[ */
var eltdfGlobalVars = {"vars":{"eltdfAddForAdminBar":0,"eltdfElementAppearAmount":-100,"eltdfAddingToCartLabel":"Adding To Cart...","eltdfAjaxUrl":"https:\/\/codegenic.co\/in\/wp-admin\/admin-ajax.php","eltdfStickyHeaderHeight":0,"eltdfStickyHeaderTransparencyHeight":70,"eltdfTopBarHeight":0,"eltdfLogoAreaHeight":0,"eltdfMenuAreaHeight":93,"eltdfMobileHeaderHeight":70}};
var eltdfPerPageVars = {"vars":{"eltdfStickyScrollAmount":0,"eltdfHeaderTransparencyHeight":0}};
/* ]]> */
</script><script type="text/javascript" src="https://codegenic.co/in/wp-content/themes/mrseo/assets/js/modules.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor/assets/js/frontend-modules.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor-pro/assets/lib/sticky/jquery.sticky.min.js"></script><script type="text/javascript">
var ElementorProFrontendConfig = {"ajaxurl":"https:\/\/codegenic.co\/in\/wp-admin\/admin-ajax.php","nonce":"d264a4ec35","shareButtonsNetworks":{"facebook":{"title":"Facebook","has_counter":true},"twitter":{"title":"Twitter"},"google":{"title":"Google+","has_counter":true},"linkedin":{"title":"LinkedIn","has_counter":true},"pinterest":{"title":"Pinterest","has_counter":true},"reddit":{"title":"Reddit","has_counter":true},"vk":{"title":"VK","has_counter":true},"odnoklassniki":{"title":"OK","has_counter":true},"tumblr":{"title":"Tumblr"},"delicious":{"title":"Delicious"},"digg":{"title":"Digg"},"skype":{"title":"Skype"},"stumbleupon":{"title":"StumbleUpon","has_counter":true},"telegram":{"title":"Telegram"},"pocket":{"title":"Pocket","has_counter":true},"xing":{"title":"XING","has_counter":true},"whatsapp":{"title":"WhatsApp"},"email":{"title":"Email"},"print":{"title":"Print"}},"facebook_sdk":{"lang":"en_US","app_id":""}};
</script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor-pro/assets/js/frontend.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-includes/js/jquery/ui/position.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor/assets/lib/dialog/dialog.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor/assets/lib/waypoints/waypoints.min.js"></script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor/assets/lib/swiper/swiper.min.js"></script><script type="text/javascript">
var elementorFrontendConfig = {"environmentMode":{"edit":false,"wpPreview":false},"is_rtl":false,"breakpoints":{"xs":0,"sm":480,"md":768,"lg":1025,"xl":1440,"xxl":1600},"version":"2.5.14","urls":{"assets":"https:\/\/codegenic.co\/in\/wp-content\/plugins\/elementor\/assets\/"},"settings":{"page":[],"general":{"elementor_global_image_lightbox":"yes","elementor_enable_lightbox_in_editor":"yes"}},"post":{"id":4216,"title":"Protecting SSL Private Keys in NGINX with HashiCorp Vault","excerpt":""}};
</script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/elementor/assets/js/frontend.min.js"></script><script type="text/javascript">
/* <![CDATA[ */
var jetElements = {"ajaxUrl":"https:\/\/codegenic.co\/in\/wp-admin\/admin-ajax.php","messages":{"invalidMail":"Please specify a valid e-mail"}};
/* ]]> */
</script><script type="text/javascript" src="https://codegenic.co/in/wp-content/plugins/jet-elements/assets/js/jet-elements.js"></script></body></html>
